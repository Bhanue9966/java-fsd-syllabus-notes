# üíæ 8. Spring Data

## 02-jdbc-template-repo.md

### üõ†Ô∏è Implementing a Repository with `JdbcTemplate`

The `JdbcTemplate` simplifies data access by providing methods for all common JDBC operations (execute, query, update). We typically inject it into a repository class to handle database communication.

#### Key `JdbcTemplate` Methods

| Method | Purpose | Usage |
| :--- | :--- | :--- |
| `update()` | Used for **DML** statements: `INSERT`, `UPDATE`, `DELETE`, and `CREATE/DROP` table statements. | Returns the number of affected rows. |
| `queryForObject()` | Used for queries expected to return **exactly one row** (e.g., getting a single entity by ID). | Requires a `RowMapper` to convert the result set row into a Java object. |
| `query()` | Used for queries expected to return **multiple rows** (e.g., fetching a list of entities). | Requires a `RowMapper` to convert each row into a Java object, returns a `List`. |
| `execute()` | Used for generic SQL, especially DDL (Data Definition Language) commands. | Does not return a result set. |

### 1\. Setup: Model and Schema

#### üìù Step 1: Define the Entity Model

**`src/main/java/com/example/model/Employee.java`**

```java
package com.example.model;

public class Employee {
    private Long id;
    private String name;
    private double salary;

    // Constructor, Getters, and Setters
    public Employee(Long id, String name, double salary) {
        this.id = id;
        this.name = name;
        this.salary = salary;
    }
    // Getters and Setters omitted for brevity...
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    public double getSalary() { return salary; }
    public void setSalary(double salary) { this.salary = salary; }
}
```

#### üìù Step 2: Define the Schema

We can use Spring Boot's automatic schema execution by placing SQL files in `src/main/resources`.

**`src/main/resources/schema.sql`**

```sql
DROP TABLE IF EXISTS employees;
CREATE TABLE employees (
    id BIGINT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    salary DOUBLE PRECISION
);
```

### 2\. Implementing the Repository (`@Repository`)

We autowire the `JdbcTemplate` and use a **`RowMapper`** to map the database columns to our Java `Employee` object fields.

#### A. Creating the `RowMapper`

A **`RowMapper`** interface implementation tells `JdbcTemplate` how to map each row of the `ResultSet` to a Java object.

```java
import java.sql.ResultSet;
import java.sql.SQLException;
import org.springframework.jdbc.core.RowMapper;

public class EmployeeRowMapper implements RowMapper<Employee> {
    @Override
    public Employee mapRow(ResultSet rs, int rowNum) throws SQLException {
        // Read columns from the ResultSet (rs) and create an Employee object
        return new Employee(
            rs.getLong("id"),
            rs.getString("name"),
            rs.getDouble("salary")
        );
    }
}
```

#### B. Implementing CRUD Operations

**`src/main/java/com/example/repository/EmployeeRepository.java`**

```java
package com.example.repository;

import com.example.model.Employee;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public class EmployeeRepository {

    private final JdbcTemplate jdbcTemplate;
    private final EmployeeRowMapper rowMapper = new EmployeeRowMapper();
    
    // SQL Statements using '?' placeholders for PreparedStatement functionality
    private static final String INSERT_SQL = "INSERT INTO employees (id, name, salary) VALUES (?, ?, ?)";
    private static final String FIND_BY_ID_SQL = "SELECT id, name, salary FROM employees WHERE id = ?";
    private static final String FIND_ALL_SQL = "SELECT id, name, salary FROM employees";
    private static final String UPDATE_SALARY_SQL = "UPDATE employees SET salary = ? WHERE id = ?";
    private static final String DELETE_SQL = "DELETE FROM employees WHERE id = ?";
    
    @Autowired
    public EmployeeRepository(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    // 1. INSERT (C - Create)
    public int save(Employee employee) {
        // Use update() for DML commands
        return jdbcTemplate.update(INSERT_SQL, 
            employee.getId(), 
            employee.getName(), 
            employee.getSalary());
    }

    // 2. SELECT ONE (R - Read)
    public Employee findById(Long id) {
        try {
            // Use queryForObject() for single results. It throws EmptyResultDataAccessException if no result is found.
            return jdbcTemplate.queryForObject(FIND_BY_ID_SQL, rowMapper, id);
        } catch (org.springframework.dao.EmptyResultDataAccessException e) {
            return null; // Handle not found case gracefully
        }
    }

    // 3. SELECT ALL (R - Read)
    public List<Employee> findAll() {
        // Use query() for multiple results
        return jdbcTemplate.query(FIND_ALL_SQL, rowMapper);
    }

    // 4. UPDATE (U - Update)
    public int updateSalary(Long id, double newSalary) {
        return jdbcTemplate.update(UPDATE_SALARY_SQL, newSalary, id);
    }

    // 5. DELETE (D - Delete)
    public int delete(Long id) {
        return jdbcTemplate.update(DELETE_SQL, id);
    }
}
```

### 3\. Execution (Example Usage)

In a service class or main method:

```java
// Assuming this code is in a service/main class where EmployeeRepository is autowired
// ...
// EmployeeRepository employeeRepository; 

// 1. Create
employeeRepository.save(new Employee(100L, "Alice", 50000.0));
employeeRepository.save(new Employee(101L, "Bob", 65000.0));
System.out.println("Employees saved.");

// 2. Read All
List<Employee> allEmployees = employeeRepository.findAll();
System.out.println("All Employees: " + allEmployees.size());

// 3. Read One
Employee bob = employeeRepository.findById(101L);
System.out.println("Bob's Salary: " + bob.getSalary());

// 4. Update
employeeRepository.updateSalary(101L, 70000.0);
bob = employeeRepository.findById(101L);
System.out.println("Bob's New Salary: " + bob.getSalary());

// 5. Delete
employeeRepository.delete(100L);
System.out.println("Alice deleted. Total remaining: " + employeeRepository.findAll().size());
```

