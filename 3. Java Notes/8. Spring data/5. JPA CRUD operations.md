# üíæ 8. Spring Data

## 05-jpa-crud-operations.md

### CRUD Operations with Spring Data JPA

Once the `ProductRepository` interface is defined (extending `JpaRepository`), the Spring container automatically provides a concrete implementation, allowing us to perform all database operations by simply calling the inherited methods.

### 1\. The Setup

We will use the **`Product`** entity and **`ProductRepository`** defined in the previous section. We will demonstrate the operations within a simple **`ProductService`** that uses Dependency Injection to acquire the repository.

#### üìù Step 1: The Service Class

The service is where we inject the repository and call its methods.

**`src/main/java/com/example/service/ProductService.java`**

```java
package com.example.service;

import com.example.model.Product;
import com.example.repository.ProductRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.util.List;
import java.util.Optional;

@Service
public class ProductService {

    private final ProductRepository productRepository;

    @Autowired
    public ProductService(ProductRepository productRepository) {
        this.productRepository = productRepository;
    }
    
    // ... CRUD methods implemented below ...
}
```

-----

### 2\. The CRUD Implementations

#### A. CREATE (Saving a new Entity)

The `save(T entity)` method is used for both creating new entities and updating existing ones. If the entity's **primary key is null**, Spring Data JPA performs an **INSERT** operation.

```java
// C - Create Operation
public Product createProduct(String name, double price) {
    Product newProduct = new Product(name, price);
    // When saved, the entity is persisted and its auto-generated ID is set.
    Product savedProduct = productRepository.save(newProduct); 
    System.out.println("‚úÖ CREATED: Product ID " + savedProduct.getId() + " saved successfully.");
    return savedProduct;
}
```

**Example Trace:**

1.  `newProduct` is created with `id=null`.
2.  `productRepository.save()` executes a SQL `INSERT`.
3.  The database generates a unique ID (e.g., 1).
4.  Spring/Hibernate sets `id=1` on the `savedProduct` object *before* returning it.

#### B. READ (Fetching Entities)

Spring Data JPA provides methods for fetching single entities and lists.

```java
// R - Read Single Entity by ID
public Optional<Product> findProductById(Long id) {
    // findById returns an Optional<T> to handle cases where the entity is not found.
    Optional<Product> productOpt = productRepository.findById(id); 
    
    if (productOpt.isPresent()) {
        System.out.println("üîé READ: Found product: " + productOpt.get().getName());
    } else {
        System.out.println("‚ùå READ: Product with ID " + id + " not found.");
    }
    return productOpt;
}

// R - Read All Entities
public List<Product> findAllProducts() {
    // findAll() returns all records from the corresponding table.
    List<Product> products = productRepository.findAll();
    System.out.println("üîé READ: Total products found: " + products.size());
    return products;
}

// R - Read using a Derived Query
public Product findProductByName(String name) {
    // Uses the custom method defined in the interface (findByName)
    Product product = productRepository.findByName(name); 
    System.out.println("üîé READ: Found by Name: " + (product != null ? product.getName() : "None"));
    return product;
}
```

#### C. UPDATE (Modifying an Existing Entity)

To update, you must first **read** the entity, modify its fields, and then call **`save(T entity)`** again. If the entity's **primary key is NOT null** (i.e., it already exists), Spring Data JPA performs an **UPDATE** operation.

```java
// U - Update Operation
public Product updateProductPrice(Long id, double newPrice) {
    // 1. Fetch the existing entity
    Optional<Product> productOpt = productRepository.findById(id);
    
    if (productOpt.isPresent()) {
        Product existingProduct = productOpt.get();
        
        // 2. Modify the field(s)
        double oldPrice = existingProduct.getPrice();
        existingProduct.setPrice(newPrice);
        
        // 3. Save the modified entity (performs an SQL UPDATE because the ID is present)
        Product updatedProduct = productRepository.save(existingProduct); 
        System.out.println("‚úèÔ∏è UPDATED: ID " + id + " price changed from " + oldPrice + " to " + newPrice);
        return updatedProduct;
    }
    System.out.println("‚ùå UPDATE FAILED: Product with ID " + id + " not found.");
    return null;
}
```

#### D. DELETE (Removing an Entity)

The `deleteById(ID id)` method removes an entity based on its primary key.

```java
// D - Delete Operation
public void deleteProduct(Long id) {
    // Spring Data JPA automatically checks if the record exists before deleting.
    productRepository.deleteById(id); 
    System.out.println("üóëÔ∏è DELETED: Product with ID " + id + " deleted (if it existed).");
}
```

-----

### 3\. Putting it All Together (Main Execution Flow)

This is how the methods would be called in a controller or main application:

```java
// Assume 'productService' is a bean injected into a Main/Test class.

// 1. CREATE
Product laptop = productService.createProduct("Laptop Pro", 1200.00);
Product mouse = productService.createProduct("Wireless Mouse", 25.50);

// 2. READ ALL
productService.findAllProducts(); 

// 3. READ SINGLE
productService.findProductById(laptop.getId());

// 4. UPDATE
productService.updateProductPrice(laptop.getId(), 1350.00); // Change laptop price

// 5. VERIFY UPDATE (READ AGAIN)
Optional<Product> updatedLaptop = productService.findProductById(laptop.getId());
updatedLaptop.ifPresent(p -> System.out.println("   Verified New Price: " + p.getPrice()));

// 6. DELETE
productService.deleteProduct(mouse.getId());

// 7. VERIFY DELETE (READ ALL AGAIN)
productService.findAllProducts(); // Should only show the Laptop
```

**Simplified Expected Output (with SQL logging enabled):**

```
Hibernate: insert into product (name, price) values (?, ?)
‚úÖ CREATED: Product ID 1 saved successfully.
Hibernate: insert into product (name, price) values (?, ?)
‚úÖ CREATED: Product ID 2 saved successfully.
Hibernate: select product0_.id as id1_0_, product0_.name as name2_0_, product0_.price as price3_0_ from product product0_
üîé READ: Total products found: 2
Hibernate: select product0_.id as id1_0_0_, product0_.name as name2_0_0_, product0_.price as price3_0_0_ from product product0_ where product0_.id=?
üîé READ: Found product: Laptop Pro
Hibernate: select product0_.id as id1_0_0_, product0_.name as name2_0_0_, product0_.price as price3_0_0_ from product product0_ where product0_.id=?
‚úèÔ∏è UPDATED: ID 1 price changed from 1200.0 to 1350.0
Hibernate: update product set name=?, price=? where id=?
Hibernate: select product0_.id as id1_0_0_, product0_.name as name2_0_0_, product0_.price as price3_0_0_ from product product0_ where product0_.id=?
üîé READ: Found product: Laptop Pro
   Verified New Price: 1350.0
Hibernate: delete from product where id=?
üóëÔ∏è DELETED: Product with ID 2 deleted (if it existed).
Hibernate: select product0_.id as id1_0_, product0_.name as name2_0_, product0_.price as price3_0_ from product product0_
üîé READ: Total products found: 1
```

