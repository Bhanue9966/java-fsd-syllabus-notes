# üåê 7. Spring Web MVC and REST

## 12-content-negotiation.md

### ü§ù Content Negotiation in REST APIs

**Content Negotiation** is the process by which the server determines the best representation (format) of a resource to return to the client, based on the client's preferences and the server's capabilities.

For Spring REST APIs, this usually means deciding whether to send the response data as **JSON**, **XML**, or another format.

### 1\. The Client's Role: The `Accept` Header

The client communicates its preferred response format to the server using the **`Accept`** HTTP request header. The value of this header is a MIME type.

| Client Goal | `Accept` Header Value |
| :--- | :--- |
| **I want JSON** | `application/json` |
| **I want XML** | `application/xml` |
| **I want HTML** | `text/html` |
| **I accept anything** | `*/*` |

### 2\. The Server's Role: `HttpMessageConverters`

Spring's **`DispatcherServlet`** consults the registered **`HttpMessageConverter`** instances.

1.  If the client requests a format (via the `Accept` header) that the server has a converter for, the server uses that converter (e.g., the Jackson converter for JSON).
2.  If the format is not supported, the server returns an **HTTP 406 Not Acceptable** status.

By default, the `spring-boot-starter-web` provides converters for **JSON** (via Jackson) and **XML** (if the Jackson XML dependency is present).

-----

### 3\. Implementation Example

To enable both JSON and XML responses, you typically need to add the Jackson XML extension library to your dependencies:

#### Maven (`pom.xml`)

```xml
<dependency>
    <groupId>com.fasterxml.jackson.dataformat</groupId>
    <artifactId>jackson-dataformat-xml</artifactId>
</dependency>
```

Once this dependency is present, Spring automatically registers the **XML converter**.

#### Controller Code (No Change Needed\!)

The beauty of content negotiation is that the Controller logic remains the same. The controller returns a Java object, and the framework handles the serialization based on the `Accept` header.

```java
@RestController
@RequestMapping("/api/orders")
public class OrderRestController {

    // Returns a Java List<Order> object
    @GetMapping
    public List<Order> getOrders() {
        // Assume this retrieves data from a service
        return List.of(new Order(1L, "Laptop", 1), new Order(2L, "Mouse", 2));
    }
}
```

#### Execution and Results

| Scenario | Client Request Header (`Accept`) | Server Response |
| :--- | :--- | :--- |
| **JSON Request** | `application/json` | **Status:** 200 OK **Body:** JSON Array |
| **XML Request** | `application/xml` | **Status:** 200 OK **Body:** XML Document |

**Example 1: JSON Output (Client requested `Accept: application/json`)**

```json
[
  { "id": 1, "item": "Laptop", "quantity": 1 },
  { "id": 2, "item": "Mouse", "quantity": 2 }
]
```

**Example 2: XML Output (Client requested `Accept: application/xml`)**

```xml
<List>
    <item>
        <id>1</id>
        <item>Laptop</item>
        <quantity>1</quantity>
    </item>
    <item>
        <id>2</id>
        <item>Mouse</item>
        <quantity>2</quantity>
    </item>
</List>
```

-----

### 4\. Alternative Method: URI Parameter (Less Common)

Although less preferred than using the `Accept` header, Spring also supports content negotiation based on a file extension appended to the URI.

#### Configuration (`application.properties`)

```properties
# Enables using extensions like /orders.xml or /orders.json
spring.mvc.contentnegotiation.favor-path-extension=true
```

#### Request Example

  * Client requests: `/api/orders.xml` $\rightarrow$ Server responds with **XML**.
  * Client requests: `/api/orders.json` $\rightarrow$ Server responds with **JSON**.

### 5\. Overriding the Content Type: The `produces` Attribute

You can force a Controller method to only produce a specific MIME type, regardless of the client's `Accept` header, by using the **`produces`** attribute on the mapping annotation.

```java
// This method will ONLY return JSON, even if the client requests XML
@GetMapping(value = "/jsononly", produces = "application/json")
public Order getJsonOrder() {
    return new Order(10L, "Keyboard", 1);
}
```

If a client attempts to access `/api/orders/jsononly` with `Accept: application/xml`, the server will return an **HTTP 406 Not Acceptable** error.

