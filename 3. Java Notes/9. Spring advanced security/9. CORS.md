# ðŸ”’ 9. Spring Advanced Security

## 09-cors.md

### 1\. The Same-Origin Policy (SOP)

To prevent malicious websites from stealing data or initiating actions on behalf of a user on another site, web browsers implement a security restriction called the **Same-Origin Policy (SOP)**.

  * **SOP Rule:** A web page can only request resources (data, scripts) from the exact same **origin** (domain, protocol, and port) that served the original page.

| Parameter | Must Match | Example |
| :--- | :--- | :--- |
| **Protocol** | `http:` or `https:` | |
| **Domain (Host)** | `bank.com` or `api.com` | |
| **Port** | `8080` or `3000` | |

### 2\. The CORS Problem

In a modern decoupled architecture:

  * **Frontend (Origin A):** Runs on a domain like `http://localhost:3000` (e.g., React Dev Server).
  * **Backend (Origin B):** Runs on a domain like `http://localhost:8080` (e.g., Spring Boot REST API).

When the JavaScript code on **Origin A** attempts to make an AJAX request to **Origin B**, the browser immediately flags this as a **Cross-Origin** request and **blocks the response** unless the server explicitly grants permission.

### 3\. Cross-Origin Resource Sharing (CORS)

**CORS** is the mechanism that allows a server (the backend) to tell the browser (the client) that it's safe to load resources from a different origin. This is achieved using special HTTP response headers.

#### The Key Header: `Access-Control-Allow-Origin`

When the browser makes a request, the server must respond with the `Access-Control-Allow-Origin` header, listing the origins that are permitted to access the resource.

| Server Response Header | Meaning |
| :--- | :--- |
| `Access-Control-Allow-Origin: *` | Grants access to **any** origin (use with caution). |
| `Access-Control-Allow-Origin: http://localhost:3000` | Grants access **only** to the specific frontend origin. |

### 4\. The Preflight Request (`OPTIONS`)

For certain "complex" HTTP requests (which include custom headers, or use methods like `PUT`, `DELETE`, or `PATCH`), the browser performs a two-step process:

1.  **Preflight (OPTIONS Request):** The browser first sends an `OPTIONS` request to the server to ask for permission.
2.  **Server Response:** The server responds with headers listing all allowed origins, allowed methods (`GET`, `POST`, `PUT`), and allowed headers.
3.  **Actual Request:** If the preflight succeeds, the browser sends the intended request (`PUT`, `DELETE`, etc.).

Spring's CORS configuration handles these `OPTIONS` requests automatically.

### 5\. Configuring CORS in Spring Boot

You can configure CORS permissions either globally (for the entire application) or specifically (per-controller or per-method).

#### A. Global Configuration (Recommended)

This approach is best for defining application-wide rules in one place using a `@Configuration` class that implements `WebMvcConfigurer`.

```java
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig implements WebMvcConfigurer {

    @Override
    public void addCorsMappings(CorsRegistry registry) {
        registry.addMapping("/api/**") // Apply to all REST API endpoints
            .allowedOrigins("http://localhost:3000", "https://yourproductiondomain.com") // Specific Origins
            .allowedMethods("GET", "POST", "PUT", "DELETE") // Allowed HTTP methods
            .allowedHeaders("*") // Allows all headers
            .allowCredentials(true) // Allows cookies (essential for session/CSRF)
            .maxAge(3600); // Cache the preflight response for 1 hour
    }
}
```

#### B. Controller/Method Configuration

For simple, individual endpoints that need specific rules, you can use the `@CrossOrigin` annotation directly on the controller class or method.

```java
@RestController
@RequestMapping("/api/users")
@CrossOrigin(origins = "http://localhost:3000") // Applies to all methods in this controller
public class UserController {
    
    // This method inherits the origin from the class-level annotation
    @GetMapping("/{id}")
    public UserDto getUserById(@PathVariable Long id) {
        // ...
    }

    // This method overrides the class-level settings for its specific needs
    @PostMapping
    @CrossOrigin(origins = "http://anotherservicedomain.com")
    public UserDto createNewUser(@RequestBody UserDto userDto) {
        // ...
    }
}
```
