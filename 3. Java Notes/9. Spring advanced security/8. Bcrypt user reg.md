# ðŸ”’ 9. Spring Advanced Security

## 08-bcrypt-user-reg.md

### 1\. The Secure User Registration Flow

The user registration process is the critical point where a user's password must be secured before it touches the database. The flow ensures the original plain-text password is **never stored**.

1.  **Client Submission:** The user submits their raw username and password via a **Registration DTO** to the REST Controller.
2.  **Controller Delegation:** The Controller passes the DTO to the Registration Service.
3.  **Encoding:** The Registration Service uses the injected **`BCryptPasswordEncoder`** to hash the raw password.
4.  **Database Save:** The Service creates the `User` entity (with the **hashed password**) and saves it to the database via the JPA Repository.

-----

### 2\. The Role of the `BCryptPasswordEncoder`

As established, passwords must be hashed using a strong, adaptive algorithm. Spring Security provides the `BCryptPasswordEncoder` to handle this.

#### A. The Required Bean

Before any password can be encoded, the `BCryptPasswordEncoder` instance must be available in the Spring context (as defined in our `SecurityConfig` from earlier modules):

```java
@Bean
public PasswordEncoder passwordEncoder() {
    // This is the production standard for secure password hashing
    return new BCryptPasswordEncoder();
}
```

#### B. The Encoding Method

The core method used for hashing is `encode(CharSequence rawPassword)`, which takes the raw string and returns the BCrypt hash prefixed with the algorithm identifier (e.g., `$2a$10$...`).

-----

### 3\. Implementation Example: Registration

We use a layered approach with a **Data Transfer Object (DTO)** to keep the client's input separate from the security-sensitive `User` entity.

#### A. Registration DTO

The DTO encapsulates the data required from the client.

```java
// src/main/java/com/app/dto/RegistrationRequest.java
public class RegistrationRequest {
    // Only includes fields the client provides
    private String username;
    private String password;
    // Getters and Setters...
}
```

#### B. Registration Service (The Key Logic)

The service is where the encoding takes place. This is the **most important step** in user registration.

```java
// src/main/java/com/app/service/AuthService.java
@Service
public class AuthService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder; // Injected BCrypt bean

    // Constructor Injection...

    public User registerNewUser(RegistrationRequest request) {
        
        // 1. Check for existing username (Business Logic)
        if (userRepository.findByUsername(request.getUsername()).isPresent()) {
            throw new RuntimeException("Username already exists.");
        }

        // 2. CRITICAL STEP: Hash the raw password
        String hashedPassword = passwordEncoder.encode(request.getPassword());
        
        // 3. Create the User entity with the HASHED password
        User newUser = new User();
        newUser.setUsername(request.getUsername());
        newUser.setPassword(hashedPassword); // Store the hash!
        newUser.setRole("ROLE_USER");
        
        // 4. Save the user to the database
        return userRepository.save(newUser);
    }
}
```

#### C. Registration Controller Endpoint

The Controller handles the HTTP request and delegates to the `AuthService`.

```java
// src/main/java/com/app/controller/AuthController.java
@RestController
@RequestMapping("/api/auth")
public class AuthController {

    private final AuthService authService;
    // Constructor Injection...

    @PostMapping("/register")
    public ResponseEntity<String> registerUser(@RequestBody RegistrationRequest request) {
        try {
            authService.registerNewUser(request);
            return new ResponseEntity<>("User registered successfully!", HttpStatus.CREATED);
        } catch (Exception e) {
            return new ResponseEntity<>(e.getMessage(), HttpStatus.BAD_REQUEST);
        }
    }
}
```

By ensuring that the raw password is run through `passwordEncoder.encode()` before it is stored, we maintain the integrity and security of the user authentication system.