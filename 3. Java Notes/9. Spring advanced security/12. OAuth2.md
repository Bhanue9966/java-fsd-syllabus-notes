# ðŸ”’ 9. Spring Advanced Security

## 12-oauth2.md

### 1\. Introduction to OAuth 2.0

**OAuth 2.0** is an **Authorization Framework** that enables a third-party application (the Client, e.g., your Spring App) to obtain limited access to a user's resources (e.g., their Google profile) hosted by a **Resource Server** (e.g., Google) without ever exposing the user's password.

Although OAuth 2.0 is strictly for authorization, it forms the basis for modern "Login with Google/GitHub" flows, which use protocols like **OpenID Connect (OIDC)** built on top of OAuth 2.0 to handle the authentication step.

#### Key Roles in the OAuth 2.0 Flow

| Role | Description | Example |
| :--- | :--- | :--- |
| **Resource Owner** | The person who owns the data (the end-user). | The user clicking "Login with Google." |
| **Client** | The application requesting access to the user's data. | **Your Spring Boot Application.** |
| **Authorization Server** | The service that holds the user's account and grants tokens. | **Google, GitHub, Facebook.** |
| **Resource Server** | The service that hosts and protects the user's resources. | Google's API endpoint for fetching user profile details. |

-----

### 2\. The Authorization Code Grant Flow

This is the standard flow used by web server applications (like Spring Boot) because it securely exchanges credentials on the backend, away from the browser.

1.  **Authorization Request:** The Client application redirects the user's browser to the Authorization Server (e.g., `google.com/oauth/authorize`).
2.  **User Consent:** The Authorization Server authenticates the user and prompts them to grant permission (consent) for the Client app to access their data.
3.  **Code Exchange:** Upon consent, the Authorization Server redirects the user back to the Client app with a temporary, single-use **Authorization Code**.
4.  **Token Acquisition (Backend):** The Client app immediately takes the Authorization Code and securely exchanges it (using its own `Client ID` and `Client Secret`) with the Authorization Server for a persistent **Access Token**.
5.  **Resource Access:** The Client uses this Access Token to call the Resource Server (e.g., Google's User Info API) to fetch the user's profile and complete the login.

-----

### 3\. Spring Boot OAuth 2.0 Implementation

Spring Security provides robust auto-configuration to handle nearly all steps of the OAuth 2.0 flow.

#### A. Dependency Setup

You need the Spring Security OAuth 2.0 Client starter dependency:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-client</artifactId>
</dependency>
```

#### B. Configuration in `application.properties`

Spring expects the OAuth provider details to be configured using standard naming conventions.

```properties
# Google OAuth 2.0 Configuration
spring.security.oauth2.client.registration.google.client-id=YOUR_GOOGLE_CLIENT_ID
spring.security.oauth2.client.registration.google.client-secret=YOUR_GOOGLE_CLIENT_SECRET
# Spring automatically defaults scope to openid, profile, email

# GitHub OAuth 2.0 Configuration
spring.security.oauth2.client.registration.github.client-id=YOUR_GITHUB_CLIENT_ID
spring.security.oauth2.client.registration.github.client-secret=YOUR_GITHUB_CLIENT_SECRET
```

Once configured, Spring Security automatically:

  * Generates the login button/link (e.g., `/oauth2/authorization/google`).
  * Handles the redirects and the authorization code exchange.
  * Creates an `OAuth2User` object representing the logged-in user.

#### C. Custom Post-Login Processing

After successful authentication, you need to either map the external user to an existing user in your database or create a new user entry. This is done by customizing the **`OAuth2UserService`**.

```java
// Spring Security Configuration (SecurityFilterChain Bean)

@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        // ... (CSRF, session settings) ...
        
        .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
        
        // Configures OAuth2 Login
        .oauth2Login(oauth -> oauth
            // 1. Specifies the URL where the user will be redirected to choose providers
            .loginPage("/login") 
            
            // 2. Specifies the custom service for post-login actions
            .userInfoEndpoint(userInfo -> userInfo
                .userService(customOAuth2UserService) // Inject your custom service here
            )
        );
    
    return http.build();
}
```

The **`customOAuth2UserService`** is a component where you implement logic to check if a user with that Google ID already exists in your `users` table, and either update their profile or register them for the first time. This completes the full authentication process using external providers.
