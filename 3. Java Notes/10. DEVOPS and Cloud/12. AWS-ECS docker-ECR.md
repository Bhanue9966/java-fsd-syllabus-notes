# ðŸš€ 10. DevOps and Cloud

## 12-aws-ecs-docker-ecr.md

### 1\. What is AWS Elastic Container Registry (ECR)?

**Amazon ECR** is a fully managed, secure, and highly available **Docker container registry** service. It serves as the single source of truth for your container images, storing them so that services like ECS (or EKS/Fargate) can reliably pull them for deployment.

  * **Role:** ECR acts as AWS's private version of **Docker Hub**.
  * **Security:** ECR is integrated with AWS Identity and Access Management (IAM) for granular access control and supports vulnerability scanning on images.

### 2\. The ECR Workflow: Local Machine to AWS

The process of moving your Spring Boot Docker image from your local development machine to ECR involves three critical steps: **Authentication, Tagging, and Pushing.**

#### Step 1: Create the ECR Repository

First, you must create a private repository in the AWS ECR service (via the console or AWS CLI) where your image will be stored.

  * **Repository Name:** Choose a name (e.g., `spring-boot-app`).
  * AWS provides a unique **Repository URI** in this format:
    ```
    <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<repository-name>
    ```

#### Step 2: Authenticate Docker to ECR (Login)

Your local Docker client needs temporary credentials to securely interact with the AWS registry. The **AWS CLI** automates this process.

```bash
# 1. Use the AWS CLI to retrieve a temporary password (token)
# 2. Pipe that token directly into the standard docker login command
aws ecr get-login-password --region <your-region> | \
docker login --username AWS --password-stdin \
<aws_account_id>.dkr.ecr.<region>.amazonaws.com
```

  * A successful command will print "Login Succeeded." The token is typically valid for 12 hours.

#### Step 3: Tag the Local Image for ECR

The local image you built (e.g., `spring-app:latest`) must be renamed (**tagged**) with the full ECR repository URI so Docker knows where to send it.

Assuming your local image is `spring-app:latest`:

```bash
docker tag spring-app:latest \
<aws_account_id>.dkr.ecr.<region>.amazonaws.com/spring-boot-app:1.0
```

  * **Crucial:** The part after `docker tag` must exactly match the full repository URI and the desired tag (e.g., `1.0`).

#### Step 4: Push the Image

Finally, use the standard `docker push` command with the newly tagged name.

```bash
docker push <aws_account_id>.dkr.ecr.<region>.amazonaws.com/spring-boot-app:1.0
```

  * Docker uploads all the image layers to your private ECR repository. Once complete, your image is ready for deployment by any AWS service with the proper permissions.

### 3\. ECR Integration with ECS

Once your image is in ECR, deploying it via ECS is seamless:

1.  **Task Definition:** When creating an ECS **Task Definition**, you specify the **Image URI** as the full ECR path (e.g., `123456789012.dkr.ecr.us-east-1.amazonaws.com/spring-boot-app:1.0`).
2.  **IAM Role:** The ECS Task Execution Role (a specific IAM role) is given permissions to execute `ecr:GetDownloadUrlForLayer`, `ecr:BatchGetImage`, etc., allowing the ECS agent to securely pull the image from the private ECR repository.

This chain of custodyâ€”build locally, push to ECR, pull by ECS/Fargateâ€”forms the core of a modern container CI/CD pipeline.
