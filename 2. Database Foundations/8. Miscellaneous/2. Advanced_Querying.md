## ⚙️ Advanced Querying 

This file details powerful SQL structures that enable complex data analysis, temporary result management, and efficient data retrieval for application display.

-----

### 1\. Common Table Expressions (CTEs)

A **Common Table Expression (CTE)** is a temporary, named result set defined within the scope of a single `SELECT`, `INSERT`, `UPDATE`, or `DELETE` statement. It is often referred to as the `WITH` clause.

#### A. Purpose and Benefits

  * **Readability:** Break down complex, multi-step queries into simple, logical, readable steps.
  * **Recursion:** CTEs are mandatory for performing recursive operations (e.g., traversing hierarchical data like organizational charts).
  * **Reusability:** The CTE can be referenced multiple times within the same subsequent query.

#### B. Basic Syntax

The CTE is defined before the main query.

```sql
WITH cta_name AS (
    -- The defining SELECT statement for the temporary result set
    SELECT column1, aggregate_function(column2) AS calculated_col
    FROM table_name
    WHERE condition
    GROUP BY column1
),
ctb_name AS (
    -- You can define multiple CTEs, separated by commas
    SELECT *
    FROM another_table
    WHERE some_condition
)
-- The main query uses the CTEs like regular tables
SELECT *
FROM cta_name
INNER JOIN ctb_name ON cta_name.id = ctb_name.id;
```

#### C. Example: Finding High-Averaging Departments

```sql
WITH DepartmentAverages AS (
    -- Step 1: Calculate the average salary for each department
    SELECT
        dept_id,
        AVG(salary) AS avg_dept_salary
    FROM
        Employees
    GROUP BY
        dept_id
)
-- Step 2: Select employees whose individual salary exceeds their department's average
SELECT
    E.first_name,
    E.salary,
    D.avg_dept_salary
FROM
    Employees AS E
INNER JOIN
    DepartmentAverages AS D
    ON E.dept_id = D.dept_id
WHERE
    E.salary > D.avg_dept_salary;
```

-----

### 2\. Window Functions

**Window Functions** perform a calculation across a set of table rows that are somehow related to the current row. Unlike aggregate functions (like `SUM()` or `AVG()` with `GROUP BY`), a window function does not collapse the rows; it retains the individual rows in the output.

#### A. Components

Window functions use the mandatory **`OVER`** clause to define the "window" or set of rows the function operates on.

  * **`PARTITION BY` (Optional):** Divides the rows into groups (partitions). The function restarts its calculation for each new partition.
  * **`ORDER BY` (Optional/Mandatory):** Orders the rows within each partition. Essential for ranking and sequential functions (like `ROW_NUMBER`, `LAG`).

#### B. Ranking Functions

These functions assign a rank to each row within its partition.

| Function | Description |
| :--- | :--- |
| **`ROW_NUMBER()`** | Assigns a sequential, unique integer starting from 1 for each row within a partition. |
| **`RANK()`** | Assigns the same rank to ties, skipping the next rank numbers. |
| **`DENSE_RANK()`**| Assigns the same rank to ties, but does **not** skip rank numbers. |

```sql
-- Example: Ranking employees within each department by salary
SELECT
    dept_id,
    first_name,
    salary,
    RANK() OVER (
        PARTITION BY dept_id  -- Rank calculation restarts for each department
        ORDER BY salary DESC   -- Ranking is based on salary (highest first)
    ) AS dept_rank
FROM Employees;
```

#### C. Analytic Functions

Standard aggregate functions can be used as window functions, applying the aggregate calculation to the defined window.

```sql
-- Example: Comparing each employee's salary to the department maximum
SELECT
    first_name,
    salary,
    MAX(salary) OVER (PARTITION BY dept_id) AS max_dept_salary
FROM Employees;
```

-----

### 3\. OFFSET / FETCH (Pagination)

The `OFFSET` and `FETCH` (or `LIMIT` in MySQL/PostgreSQL) clauses are used to control how many rows are skipped and how many are returned. This is essential for implementing **pagination** in applications (e.g., showing page 2 of 10 results).

#### A. Requirement

These clauses must always be used in conjunction with the **`ORDER BY`** clause to ensure a consistent and meaningful result set order.

#### B. Syntax (ANSI Standard - SQL Server/Oracle)

```sql
SELECT product_name, price
FROM Products
ORDER BY product_name  -- Required for consistent pagination
OFFSET 20 ROWS         -- Skip the first 20 rows (i.e., skipping two pages of 10)
FETCH NEXT 10 ROWS ONLY; -- Return the next 10 rows (i.e., Page 3)
```

#### C. Syntax (MySQL/PostgreSQL)

```sql
SELECT product_name, price
FROM Products
ORDER BY product_name
LIMIT 10      -- Return 10 rows
OFFSET 20;    -- Skip 20 rows
```