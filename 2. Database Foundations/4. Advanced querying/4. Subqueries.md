## ðŸ§± Subqueries

A **Subquery** (or inner query, nested query) is a query embedded within another SQL query (the outer query). Subqueries are powerful tools that allow complex filtering, calculation, and comparison operations that cannot be achieved with simple `JOIN` or `WHERE` clauses alone.

-----

### 1\. Fundamentals of Subqueries

A subquery is always enclosed in parentheses and executed before the outer query. The result of the subquery is then used by the outer query.

#### A. Subquery Types

| Type | Description | Placement | Result Type |
| :--- | :--- | :--- | :--- |
| **Scalar** | Returns a single value (one column, one row). | `SELECT`, `WHERE`, `HAVING` | Single Value |
| **Multi-Row** | Returns a list of values (one column, multiple rows). | `WHERE`, `HAVING` (used with `IN`, `ANY`, `ALL`) | List of Values |
| **Multi-Column** | Returns one row with multiple columns. | `WHERE` (used for row-by-row comparisons) | Row |
| **Correlated** | Depends on the outer query for its execution (runs once per row of the outer query). | `WHERE`, `HAVING`, `SELECT` | Varies |

-----

### 2\. Subqueries in the `WHERE` Clause (Filtering)

This is the most common use, allowing the outer query to filter based on a value or set of values calculated by the inner query.

#### A. Scalar Subquery in `WHERE`

Used with comparison operators (`=`, `>`, `<`, etc.).

```sql
-- Example: Find employees who earn more than the average salary
SELECT
    first_name,
    salary
FROM Employees
WHERE salary > (
    SELECT AVG(salary)
    FROM Employees
);
```

#### B. Multi-Row Subquery in `WHERE`

Used with set operators (`IN`, `NOT IN`, `ANY`, `ALL`).

| Operator | Description |
| :--- | :--- |
| **`IN`** | The outer query value matches **any** value returned by the subquery. |
| **`NOT IN`** | The outer query value matches **none** of the values returned by the subquery. |
| **`ANY`** / **`SOME`** | The outer query value meets the condition (e.g., `> ANY`) for at least **one** value returned by the subquery. |
| **`ALL`** | The outer query value meets the condition (e.g., `< ALL`) for **every** value returned by the subquery. |

```sql
-- Example: Find employees working in the 'Finance' or 'HR' departments
SELECT
    first_name,
    last_name
FROM Employees
WHERE dept_id IN (
    SELECT dept_id
    FROM Departments
    WHERE dept_name IN ('Finance', 'HR')
);
```

-----

### 3\. Correlated Subqueries

A **correlated subquery** relies on values from the outer query. It executes once for **each row** processed by the outer query, making it less efficient than non-correlated subqueries but necessary for certain row-by-row comparisons.

#### A. Correlated Subquery in `WHERE`

```sql
-- Example: Find all employees who earn the highest salary in their respective department
SELECT
    E1.first_name,
    E1.dept_id,
    E1.salary
FROM Employees E1
WHERE E1.salary = ( -- Subquery runs for each row of E1
    SELECT MAX(E2.salary)
    FROM Employees E2
    WHERE E2.dept_id = E1.dept_id -- Correlation condition
);
```

#### B. The `EXISTS` Operator

`EXISTS` tests for the existence of rows returned by the subquery. It returns `TRUE` if the subquery returns at least one row, and `FALSE` otherwise. It is almost always used with a correlated subquery.

```sql
-- Example: Find departments that currently have at least one active employee
SELECT
    dept_name
FROM Departments D
WHERE EXISTS (
    SELECT 1 -- 1 is used as a placeholder, actual column value doesn't matter
    FROM Employees E
    WHERE E.dept_id = D.dept_id -- Correlation condition
      AND E.status = 'Active'
);
```

-----

### 4\. Subqueries in the `FROM` Clause (Derived Tables)

When a subquery is placed in the `FROM` clause, its result set is treated as a temporary, inline table, often called a **Derived Table**. This is crucial for performing calculations or aggregations before joining or filtering the results. **A derived table must always be given an alias.**

```sql
-- Example: Find the max salary from departments whose average salary is over 60000
SELECT
    T1.dept_id,
    MAX(T1.avg_salary) AS Max_Avg_Salary
FROM (
    -- Derived Table T1: Calculates average salary per department
    SELECT dept_id, AVG(salary) AS avg_salary
    FROM Employees
    GROUP BY dept_id
    HAVING AVG(salary) > 60000
) AS T1 -- Must be aliased (T1)
INNER JOIN Departments D
  ON T1.dept_id = D.dept_id
GROUP BY T1.dept_id;
```

-----

### 5\. Subqueries in the `SELECT` Clause (Scalar Only)

Scalar subqueries can be included in the `SELECT` list to return a single value for each row of the outer query. This is often used to display calculated aggregate information alongside detailed row data.

```sql
-- Example: List each employee's salary alongside the overall company average salary
SELECT
    first_name,
    salary,
    (
        SELECT AVG(salary) -- Scalar subquery
        FROM Employees
    ) AS Company_Avg_Salary
FROM Employees;
```